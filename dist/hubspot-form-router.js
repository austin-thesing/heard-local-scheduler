(function(){let L={general:{url:"https://meetings.hubspot.com/bz/consultation",name:"Consultation Scheduler",description:"General consultation scheduling"}},_={success:"/thank-you/success",schedule:"/thank-you/schedule"},U=["do_you_file_taxes_as_an_independent_contractor_or_as_the_sole_owner_of_your_business_","does_your_practice_have_multiple_owners"],N=["yes","true","y","1","multiple owners","multi"],T=["no","false","n","0"];function C(q){if(q==null)return"";return String(q).trim().toLowerCase()}function E(q){let Q=C(q);if(!Q)return!1;if(N.includes(Q))return!0;return Q.startsWith("yes")||Q.includes("multiple owners")||Q.includes("multi practice")||Q.includes("multi-owner")||Q.includes("multi owner")||Q.includes("multi-practice")}function d(q){let Q=C(q);if(!Q)return!1;if(T.includes(Q))return!0;return Q.startsWith("no")}function S(q,Q){if(!q)return null;for(let W of Q){if(q[W])return q[W];let j=[`0-1/${W}`,`0-2/${W}`,`0-3/${W}`];for(let X of j)if(q[X])return q[X]}return null}let b=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function Z(...q){if(b)console.log("[HubSpot Router]",...q)}let z="partnerstack_click_id",F=[z,"ps_xid","psx_id"],I=["ps_xid","psx_id"];function R(q){try{if(!document.cookie)return null;let Q=document.cookie.split(";");for(let W of Q){let j=W.trim();if(!j)continue;if(j.startsWith(`${q}=`)){let[,X]=j.split("=");if(X)return decodeURIComponent(X)}}}catch(Q){Z(`cookie access error for ${q}:`,Q)}return null}function v(q){if(!q)return;let Q=F.flatMap((j)=>[`input[name="${j}"]`,`input[name$="/${j}"]`]);if(Q.length===0)return;let W;try{W=document.querySelectorAll(Q.join(", ")),Z("PartnerStack selector found",W.length,"inputs:",Q.join(", "))}catch(j){Z("Failed to query partnerstack inputs:",j);return}if(!W||W.length===0){Z("No PartnerStack inputs found with selectors:",Q.join(", "));return}window._capturedFormData=window._capturedFormData||{},W.forEach((j)=>{if(!j||typeof j.name!=="string")return;let X=j.value;if(!j.value){j.value=q;try{j.setAttribute("value",q),Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(j,q);let J=new Event("input",{bubbles:!0});j.dispatchEvent(J);let H=new Event("change",{bubbles:!0});j.dispatchEvent(H)}catch($){Z("Failed to trigger input events:",$)}}window._capturedFormData[j.name]=j.value;let x=G(j.name);if(x&&x!==j.name)window._capturedFormData[x]=j.value;Z("Prefilled partnerstack id field:",j.name,"=",j.value,X?`(overwrote: ${X})`:"(was empty)")})}function g(q,Q,W,j){if(!q||!Q||!W){Z("Missing required data for HubSpot submission");return}let X=`https://api.hsforms.com/submissions/v3/integration/submit/${Q}/${q}`,x={fields:[{name:"partnerstack_click_id",value:W}],context:{pageUri:window.location.href,pageName:document.title}};if(j)x.fields.push({name:"email",value:j});Z("Submitting PartnerStack ID to HubSpot:",x),fetch(X,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)}).then(($)=>{if($.ok)Z("Successfully submitted PartnerStack ID to HubSpot");else Z("Failed to submit PartnerStack ID to HubSpot:",$.status)}).catch(($)=>{Z("Error submitting PartnerStack ID to HubSpot:",$)})}function O(){let q=[];for(let j of I){let X=R(j);if(X)Z("Found PartnerStack ID in cookie",j+":",X),q.push(X)}try{if(window.partnerstack&&window.partnerstack.ps_xid)Z("Found PartnerStack ID in window.partnerstack:",window.partnerstack.ps_xid),q.push(window.partnerstack.ps_xid)}catch(j){Z("Partnerstack global lookup error:",j)}try{if(window.ps_xid)Z("Found PartnerStack ID in window.ps_xid:",window.ps_xid),q.push(window.ps_xid)}catch(j){Z("ps_xid global lookup error:",j)}try{F.forEach((j)=>{let X=localStorage.getItem(j);if(X)Z("Found PartnerStack ID in localStorage",j+":",X),q.push(X)})}catch(j){Z("localStorage access error for partnerstack id:",j)}try{F.forEach((j)=>{let X=sessionStorage.getItem(j);if(X)Z("Found PartnerStack ID in sessionStorage",j+":",X),q.push(X)})}catch(j){Z("sessionStorage access error for partnerstack id:",j)}let Q=R(z);if(Q&&!q.includes(Q))Z("Found PartnerStack ID in partnerstack_click_id cookie:",Q),q.push(Q);Z("All PartnerStack ID candidates:",q);let W=q.find((j)=>j&&j!=="undefined"&&j!=="null");return Z("Resolved PartnerStack ID:",W),W||null}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=b;let A=!1;function G(q){try{if(!q)return"";let Q=String(q);return Q.indexOf("/")!==-1?Q.split("/").pop():Q}catch(Q){return q}}function k(q){let Q={};if(!q)return Q;if(Array.isArray(q))return q.forEach((W)=>{if(!W)return;let j=W.name||W.field||"",X=G(j),x=typeof W.value==="string"?W.value:Array.isArray(W.value)?W.value[0]:W.value!=null?String(W.value):"";if(j)Q[j]=x;if(X&&X!==j)Q[X]=x}),Q;if(q.fields){let W=q.fields;if(Array.isArray(W))W.forEach((j)=>{if(!j)return;let X=j.name||j.field||"",x=G(X),$=typeof j.value==="string"?j.value:Array.isArray(j.value)?j.value[0]:j.value!=null?String(j.value):"";if(X)Q[X]=$;if(x&&x!==X)Q[x]=$});else if(typeof W==="object")Object.entries(W).forEach(([j,X])=>{let x=G(j),$=typeof X==="string"?X:Array.isArray(X)?X[0]:X!=null?String(X):"";if(Q[j]=$,x&&x!==j)Q[x]=$});return Q}return Object.entries(q).forEach(([W,j])=>{let X=G(W),x=typeof j==="string"?j:Array.isArray(j)?j[0]:j!=null?String(j):"";if(Q[W]=x,X&&X!==W)Q[X]=x}),Q}function P(q){let Q=S(q,U),W=Q&&E(Q);if(!W)return Z("Multi-practice question not answered yes, routing to success page",{field:U.find((j)=>q[j]),value:Q,hasYes:W}),"success";return Z("Multi-practice question answered yes, routing to scheduler",{multiPracticeValue:Q}),"general"}function K(q,Q){let W=L[q]||L.general,j=new URL(W.url);return j.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([$,J])=>{for(let H of J)if(Q[H]){j.searchParams.set($,Q[H]),Z(`Mapping ${H} -> ${$}: ${Q[H]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach(($)=>{if(Q[$])j.searchParams.set($,Q[$])}),Z("Built scheduler URL:",j.toString()),j.toString()}function y(q,Q){if(Q==="success"){let x=new URLSearchParams;if(q.email)x.set("email",q.email);let $=`${_.success}${x.toString()?"?"+x.toString():""}`;Z("Redirecting to success page for soft rejection:",$);try{window.location.replace($)}catch(J){Z("replace() failed, using href for success redirect",J),window.location.href=$}return}let W={scheduler_type:Q,formData:q,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(W)),Z("Stored router data in sessionStorage")}catch(x){Z("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${Q}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(q))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(q)),Z("Stored form data in localStorage for prefill")}catch(x){Z("Failed to store form data in localStorage:",x)}let j=new URLSearchParams;if(q.email)j.set("email",q.email);let X=`${_.schedule}${j.toString()?"?"+j.toString():""}`;Z("Redirecting to:",X);try{window.location.replace(X)}catch(x){Z("replace() failed, using href for scheduler redirect",x),window.location.href=X}}function M(q,Q={}){if(Z("Form submission detected:",q),A){Z("Routing already performed; skipping");return}A=!0;let W=O();if(W){q.partnerstack_click_id=W,q["0-1/partnerstack_click_id"]=W,q["0-2/partnerstack_click_id"]=W,q["0-3/partnerstack_click_id"]=W,Z("Injected PartnerStack ID into submission:",W);try{sessionStorage.setItem(z,W)}catch(X){Z("Failed to persist partnerstack id in sessionStorage:",X)}try{localStorage.setItem(z,W)}catch(X){Z("Failed to persist partnerstack id in localStorage:",X)}if(Q.formGuid&&Q.portalId)g(Q.formGuid,Q.portalId,W,q.email)}let j=P(q);if(y(q,j),typeof window.amplitude<"u")window.amplitude.track("scheduler_router_triggered",{scheduler_type:j,has_email:!!q.email,has_name:!!(q.firstname||q.first_name)});if(typeof window.posthog<"u")window.posthog.capture("scheduler_router_triggered",{scheduler_type:j,method:"redirect"})}function D(){window._capturedFormData=window._capturedFormData||{};let q={},Q=new WeakSet;function W(X,x="change"){if(!X.name)return;let $=X.name,J=G($),H=X.value,B=H;if(X.type==="radio"){let Y=X.closest("label");if(Y&&Y.textContent){let w=Y.textContent.replace(/\s+/g," ").trim();if(w)B=w}}if(q[$]===B)return;if(q[$]=B,$==="hs_context"||$.startsWith("hs_")||$==="guid")return;if(window._capturedFormData[$]=B,J&&J!==$)window._capturedFormData[J]=B;if(X.type==="radio"){if(window._capturedFormData[`${$}_raw`]=H,J&&J!==$)window._capturedFormData[`${J}_raw`]=H;let Y=document.querySelector(`input[type="hidden"][name="${$}"]`);if(Y&&Y.value){if(window._capturedFormData[$]=Y.value,J&&J!==$)window._capturedFormData[J]=Y.value;B=Y.value}}if(B){let Y=X.type||X.tagName.toLowerCase();if(X.type==="tel"||$.toLowerCase().includes("phone")){let w=B.replace(/[\s\-\(\)\.]/g,"");if(w)window._capturedFormData[$+"_clean"]=w;Z("Captured phone:",$,"=",B)}else if(X.type==="radio")Z("Captured radio selection:",$,"=",B,"(raw:",H,")");else if(X.type==="hidden"){if($==="hs_context"||$.startsWith("hs_")||$==="guid")return;if(X.closest(".hsfc-DropdownField"))Z("Captured dropdown:",$,"=",B);else Z("Captured field:",$,"=",B)}else Z("Captured",Y+":",$,"=",B)}}function j(){let X=O();if(X)v(X);let x=new MutationObserver((J)=>{let H=[];if(J.forEach((B)=>{B.addedNodes.forEach((Y)=>{if(Y.nodeType===1)H.push(Y)})}),H.length===0)return;H.forEach((B)=>{let Y=B.querySelectorAll?B.querySelectorAll("input[name], select[name], textarea[name]"):[];if(B.tagName&&(B.tagName==="INPUT"||B.tagName==="SELECT"||B.tagName==="TEXTAREA")&&B.name)$(B);Y.forEach((w)=>$(w))})});function $(J){if(Q.has(J))return;if(Q.add(J),J.readOnly&&J.type!=="hidden")return;let H=J.name?G(J.name):"";if(J.name===z||H===z||J.name.endsWith("/"+z)){let B=O();if(B&&!J.value){J.value=B;try{J.setAttribute("value",B),Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(J,B);let w=new Event("input",{bubbles:!0});J.dispatchEvent(w);let V=new Event("change",{bubbles:!0});J.dispatchEvent(V)}catch(Y){Z("Failed to trigger events on partnerstack field:",Y)}W(J,"partnerstack_prefill")}}if(J.type==="hidden"&&J.name){let B=J.value,Y=setInterval(()=>{if(J.value!==B)B=J.value,W(J,"programmatic");if(!document.body.contains(J))clearInterval(Y)},500);if(J.value)W(J,"initial");else{let w=O();if(w&&(J.name===z||G(J.name)===z||J.name.endsWith("/"+z))){J.value=w;try{J.setAttribute("value",w),Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(J,w);let m=new Event("input",{bubbles:!0});J.dispatchEvent(m);let s=new Event("change",{bubbles:!0});J.dispatchEvent(s)}catch(V){Z("Failed to trigger events on hidden partnerstack field:",V)}W(J,"partnerstack_prefill_hidden")}}}else if(J.type==="radio")J.addEventListener("change",()=>W(J));else if(J.type==="tel"||J.name&&J.name.toLowerCase().includes("phone"))J.addEventListener("blur",()=>W(J)),J.addEventListener("change",()=>W(J));else if(J.addEventListener("change",()=>W(J)),J.addEventListener("blur",()=>W(J)),J.value)W(J,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach($),x.observe(document.body,{childList:!0,subtree:!0}),Z("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",j);else j()}function f(q){if(!q)return!1;let Q=!!S(q,U);return Boolean(q.email||q.firstname||q.first_name||q.lastname||q.last_name||q.company||q.practice_name)||Q}function c(q={}){Z("Initializing postMessage listener"),window.addEventListener("message",function(Q){if(!function($){try{let J=new URL($).hostname;return J.endsWith("hubspot.com")||J.endsWith("hsforms.com")||J.endsWith("hsforms.net")||J.endsWith("hsappstatic.net")||J.includes("hubspot")||J.includes("hsforms")}catch(J){return!1}}(Q.origin))return;let j=Q.data;if(typeof j==="string")try{j=JSON.parse(j)}catch($){}Z("Received message from HubSpot:",j);let X=j&&(j.type||j.messageType),x=j&&j.eventName;if(j&&X==="hsFormCallback"&&x==="onFormReady"){Z("Form ready event detected, injecting PartnerStack ID");let $=O();if($)setTimeout(()=>{document.querySelectorAll('input[name="partnerstack_click_id"], input[name$="/partnerstack_click_id"]').forEach((H)=>{if(H&&!H.value){H.value=$;try{H.setAttribute("value",$),Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(H,$);let Y=new Event("input",{bubbles:!0});H.dispatchEvent(Y);let w=new Event("change",{bubbles:!0});H.dispatchEvent(w),Z("Injected PartnerStack ID into form field:",H.name,"=",$)}catch(B){Z("Failed to trigger events on form ready:",B)}}})},100)}else if(j&&X==="hsFormCallback"&&(x==="onFormSubmitted"||x==="onFormSubmit")){let $=j&&j.data?k(j.data):{},J=window._capturedFormData&&typeof window._capturedFormData==="object"?window._capturedFormData:{},H={...$,...J};if(!f(H)){if(x==="onFormSubmit")Z("onFormSubmit received without routing fields; waiting for onFormSubmitted event");else Z("Submission payload lacks routing data; skipping redirect");return}try{window._capturedFormData={...H}}catch(Y){Z("Failed to persist merged submission data globally:",Y)}let B={...q,formGuid:j.data?.formGuid||j.formGuid,portalId:j.data?.portalId||j.portalId};M(H,B)}else if(j&&j.formGuid&&j.accepted===!0){if(Z("Developer embed submission detected"),Z("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),Z("Stored captured form data in localStorage for prefill")}catch(J){Z("Failed to store captured form data in localStorage:",J)}let $={...q,formGuid:j.formGuid,portalId:j.portalId};M(window._capturedFormData,$)}}else if(j&&X==="hsFormCallback"&&b)Z("Ignoring hsFormCallback event:",x)}),Z("PostMessage listener initialized")}function h(q={}){let W={...{redirect:!0,debug:b},...q};if(W.debug)window.HubSpotRouterDebug={config:L,determineSchedulerType:P,buildSchedulerUrl:K,handleFormSubmission:M},Z("Debug mode enabled. Access via window.HubSpotRouterDebug");D(),c(W),Z("HubSpot Form Router initialized with config:",W)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>h());else h();window.HubSpotRouter={...window.HubSpotRouter,init:h,handleFormSubmission:M,determineSchedulerType:P,buildSchedulerUrl:K,config:L,DEBUG:b},Z("HubSpot Form Router loaded")})();
