(function(){let M={sole_prop:{url:"https://meetings.hubspot.com/bz/consultation",name:"Sole Proprietor Consultation",description:"For single-owner practices"}},H=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function X(...Q){if(H)console.log("[HubSpot Router]",...Q)}let z="partnerstack_click_id",w=[z,"ps_xid"];function P(){let Q=[];try{if(window.partnerstack&&window.partnerstack.ps_xid)Q.push(window.partnerstack.ps_xid)}catch(q){X("Partnerstack global lookup error:",q)}try{if(window.ps_xid)Q.push(window.ps_xid)}catch(q){X("ps_xid global lookup error:",q)}try{w.forEach((q)=>{let j=localStorage.getItem(q);if(j)Q.push(j)})}catch(q){X("localStorage access error for partnerstack id:",q)}try{w.forEach((q)=>{let j=sessionStorage.getItem(q);if(j)Q.push(j)})}catch(q){X("sessionStorage access error for partnerstack id:",q)}try{let q=document.cookie.split(";").map((j)=>j.trim()).find((j)=>j.startsWith(`${z}=`));if(q){let[,j]=q.split("=");if(j)Q.push(decodeURIComponent(j))}}catch(q){X("cookie access error for partnerstack id:",q)}return Q.find((q)=>q&&q!=="undefined"&&q!=="null")||null}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=H;let U=!1;function b(Q){try{if(!Q)return"";let $=String(Q);return $.indexOf("/")!==-1?$.split("/").pop():$}catch($){return Q}}function V(Q){let $={};if(!Q)return $;if(Array.isArray(Q))return Q.forEach((q)=>{if(!q)return;let j=q.name||q.field||"",W=b(j),x=typeof q.value==="string"?q.value:Array.isArray(q.value)?q.value[0]:q.value!=null?String(q.value):"";if(j)$[j]=x;if(W&&W!==j)$[W]=x}),$;if(Q.fields){let q=Q.fields;if(Array.isArray(q))q.forEach((j)=>{if(!j)return;let W=j.name||j.field||"",x=b(W),J=typeof j.value==="string"?j.value:Array.isArray(j.value)?j.value[0]:j.value!=null?String(j.value):"";if(W)$[W]=J;if(x&&x!==W)$[x]=J});else if(typeof q==="object")Object.entries(q).forEach(([j,W])=>{let x=b(j),J=typeof W==="string"?W:Array.isArray(W)?W[0]:W!=null?String(W):"";if($[j]=J,x&&x!==j)$[x]=J});return $}return Object.entries(Q).forEach(([q,j])=>{let W=b(q),x=typeof j==="string"?j:Array.isArray(j)?j[0]:j!=null?String(j):"";if($[q]=x,W&&W!==q)$[W]=x}),$}function L(Q){X("Determining scheduler type from form data:",Q);let $=["is_your_practice_a_c_corp_or_our_does_it_have_multiple_owners_","does_your_practice_have_multiple_owners","multiple_owners","practice_multiple_owners","has_multiple_owners"],q=null;for(let W of $)if(Q[W]){q=Q[W],X(`Found multiple owners field: ${W} = ${q}`);break}if(!q)return X("No multiple owners field found, using default"),"default";let j=q.toString().toLowerCase().trim();if(j==="no"||j==="false")return X("Single owner detected -> sole_prop"),"sole_prop";else if(j==="yes"||j==="true")return X("Multiple owners detected -> s_corp"),"s_corp";return X("Unclear response, using default"),"default"}function C(Q,$){let q=M[Q]||M.default,j=new URL(q.url);return j.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([J,Z])=>{for(let Y of Z)if($[Y]){j.searchParams.set(J,$[Y]),X(`Mapping ${Y} -> ${J}: ${$[Y]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach((J)=>{if($[J])j.searchParams.set(J,$[J])}),X("Built scheduler URL:",j.toString()),j.toString()}function F(Q,$){let q={scheduler_type:$,formData:Q,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(q)),X("Stored router data in sessionStorage")}catch(x){X("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${$}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(Q))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(Q)),X("Stored form data in localStorage for prefill")}catch(x){X("Failed to store form data in localStorage:",x)}let j=new URLSearchParams;if(Q.email)j.set("email",Q.email);let W=`/hs-scheduler/ty-general${j.toString()?"?"+j.toString():""}`;X("Redirecting to:",W),window.location.href=W}function G(Q,$={}){if(X("Form submission detected:",Q),U){X("Routing already performed; skipping");return}U=!0;let q=P();if(q){if(!Q[z])Q[z]=q;try{sessionStorage.setItem(z,q)}catch(W){X("Failed to persist partnerstack id in sessionStorage:",W)}try{localStorage.setItem(z,q)}catch(W){X("Failed to persist partnerstack id in localStorage:",W)}}let j=L(Q);if(F(Q,j),typeof window.amplitude<"u")window.amplitude.track("scheduler_router_triggered",{scheduler_type:j,has_email:!!Q.email,has_name:!!(Q.firstname||Q.first_name)});if(typeof window.posthog<"u")window.posthog.capture("scheduler_router_triggered",{scheduler_type:j,method:"redirect"})}function _(){window._capturedFormData=window._capturedFormData||{};let Q={},$=new WeakSet;function q(W,x="change"){if(!W.name)return;let{value:J,name:Z}=W;if(Q[Z]===J)return;if(Q[Z]=J,Z==="hs_context"||Z.startsWith("hs_")||Z==="guid")return;if(window._capturedFormData[Z]=J,J){let Y=W.type||W.tagName.toLowerCase();if(W.type==="tel"||Z.toLowerCase().includes("phone")){let B=J.replace(/[\s\-\(\)\.]/g,"");if(B)window._capturedFormData[Z+"_clean"]=B;X("Captured phone:",Z,"=",J)}else if(W.type==="radio")X("Captured radio selection:",Z,"=",J);else if(W.type==="hidden"){if(Z==="hs_context"||Z.startsWith("hs_")||Z==="guid")return;if(W.closest(".hsfc-DropdownField"))X("Captured dropdown:",Z,"=",J);else X("Captured field:",Z,"=",J)}else X("Captured",Y+":",Z,"=",J)}}function j(){let W=new MutationObserver((J)=>{let Z=[];if(J.forEach((Y)=>{Y.addedNodes.forEach((B)=>{if(B.nodeType===1)Z.push(B)})}),Z.length===0)return;Z.forEach((Y)=>{let B=Y.querySelectorAll?Y.querySelectorAll("input[name], select[name], textarea[name]"):[];if(Y.tagName&&(Y.tagName==="INPUT"||Y.tagName==="SELECT"||Y.tagName==="TEXTAREA")&&Y.name)x(Y);B.forEach((R)=>x(R))})});function x(J){if($.has(J))return;if($.add(J),J.readOnly&&J.type!=="hidden")return;if(J.name===z&&!J.value){let Z=P();if(Z)J.value=Z,q(J,"partnerstack_prefill")}if(J.type==="hidden"&&J.name){let Z=J.value,Y=setInterval(()=>{if(J.value!==Z)Z=J.value,q(J,"programmatic");if(!document.body.contains(J))clearInterval(Y)},500);if(J.value)q(J,"initial")}else if(J.type==="radio")J.addEventListener("change",()=>q(J));else if(J.type==="tel"||J.name&&J.name.toLowerCase().includes("phone"))J.addEventListener("blur",()=>q(J)),J.addEventListener("change",()=>q(J));else if(J.addEventListener("change",()=>q(J)),J.addEventListener("blur",()=>q(J)),J.value)q(J,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach(x),W.observe(document.body,{childList:!0,subtree:!0}),X("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",j);else j()}function I(Q={}){X("Initializing postMessage listener"),window.addEventListener("message",function($){if(!function(J){try{let Z=new URL(J).hostname;return Z.endsWith("hubspot.com")||Z.endsWith("hsforms.com")||Z.endsWith("hsforms.net")||Z.endsWith("hsappstatic.net")||Z.includes("hubspot")||Z.includes("hsforms")}catch(Z){return!1}}($.origin))return;let j=$.data;if(typeof j==="string")try{j=JSON.parse(j)}catch(J){}X("Received message from HubSpot:",j);let W=j&&(j.type||j.messageType),x=j&&j.eventName;if(j&&W==="hsFormCallback"&&(x==="onFormSubmitted"||x==="onFormSubmit")){let J=j.data;if(J){let Z=V(J);G(Z,Q)}}else if(j&&j.formGuid&&j.accepted===!0){if(X("Developer embed submission detected"),X("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),X("Stored captured form data in localStorage for prefill")}catch(J){X("Failed to store captured form data in localStorage:",J)}G(window._capturedFormData,Q)}}else if(j&&W==="hsFormCallback"&&H)X("Ignoring hsFormCallback event:",x)}),X("PostMessage listener initialized")}function O(Q={}){let q={...{redirect:!0,debug:H},...Q};if(q.debug)window.HubSpotRouterDebug={config:M,determineSchedulerType:L,buildSchedulerUrl:C,handleFormSubmission:G},X("Debug mode enabled. Access via window.HubSpotRouterDebug");_(),I(q),X("HubSpot Form Router initialized with config:",q)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>O());else O();window.HubSpotRouter={...window.HubSpotRouter,init:O,handleFormSubmission:G,determineSchedulerType:L,buildSchedulerUrl:C,config:M,DEBUG:H},X("HubSpot Form Router loaded")})();
