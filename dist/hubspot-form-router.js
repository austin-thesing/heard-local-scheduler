(function(){let U={general:{url:"https://meetings.hubspot.com/bz/consultation",name:"Consultation Scheduler",description:"General consultation scheduling"}},S={success:"/thank-you/success",schedule:"/thank-you/schedule"},F=["do_you_file_taxes_as_an_independent_contractor_or_as_the_sole_owner_of_your_business_","does_your_practice_have_multiple_owners"],A=["yes","true","y","1","multiple owners","multi"],I=["no","false","n","0"];function R(q){if(q==null)return"";return String(q).trim().toLowerCase()}function v(q){let J=R(q);if(!J)return!1;if(A.includes(J))return!0;return J.startsWith("yes")||J.includes("multiple owners")||J.includes("multi practice")||J.includes("multi-owner")||J.includes("multi owner")||J.includes("multi-practice")}function c(q){let J=R(q);if(!J)return!1;if(I.includes(J))return!0;return J.startsWith("no")}function _(q,J){if(!q)return null;for(let Q of J){if(q[Q])return q[Q];let j=[`0-1/${Q}`,`0-2/${Q}`,`0-3/${Q}`];for(let W of j)if(q[W])return q[W]}return null}let O=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function $(...q){if(O)console.log("[HubSpot Router]",...q)}let G="partnerstack_click_id",h=[G,"ps_xid","psx_id"],k=["ps_xid","psx_id"];function K(q){try{if(!document.cookie)return null;let J=document.cookie.split(";");for(let Q of J){let j=Q.trim();if(!j)continue;if(j.startsWith(`${q}=`)){let[,W]=j.split("=");if(W)return decodeURIComponent(W)}}}catch(J){$(`cookie access error for ${q}:`,J)}return null}function y(q){if(!q)return;let J=h.flatMap((j)=>[`input[name="${j}"]`,`input[name$="/${j}"]`]);if(J.length===0)return;let Q;try{Q=document.querySelectorAll(J.join(", "))}catch(j){$("Failed to query partnerstack inputs:",j);return}if(!Q||Q.length===0)return;window._capturedFormData=window._capturedFormData||{},Q.forEach((j)=>{if(!j||typeof j.name!=="string")return;if(!j.value)j.value=q;window._capturedFormData[j.name]=j.value;let W=B(j.name);if(W&&W!==j.name)window._capturedFormData[W]=j.value;$("Prefilled partnerstack id field:",j.name,"=",j.value)})}function P(){let q=[];for(let j of k){let W=K(j);if(W)q.push(W)}try{if(window.partnerstack&&window.partnerstack.ps_xid)q.push(window.partnerstack.ps_xid)}catch(j){$("Partnerstack global lookup error:",j)}try{if(window.ps_xid)q.push(window.ps_xid)}catch(j){$("ps_xid global lookup error:",j)}try{h.forEach((j)=>{let W=localStorage.getItem(j);if(W)q.push(W)})}catch(j){$("localStorage access error for partnerstack id:",j)}try{h.forEach((j)=>{let W=sessionStorage.getItem(j);if(W)q.push(W)})}catch(j){$("sessionStorage access error for partnerstack id:",j)}let J=K(G);if(J&&!q.includes(J))q.push(J);return q.find((j)=>j&&j!=="undefined"&&j!=="null")||null}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=O;let M=!1,b=null;function B(q){try{if(!q)return"";let J=String(q);return J.indexOf("/")!==-1?J.split("/").pop():J}catch(J){return q}}function E(q){let J={};if(!q)return J;if(Array.isArray(q))return q.forEach((Q)=>{if(!Q)return;let j=Q.name||Q.field||"",W=B(j),Y=typeof Q.value==="string"?Q.value:Array.isArray(Q.value)?Q.value[0]:Q.value!=null?String(Q.value):"";if(j)J[j]=Y;if(W&&W!==j)J[W]=Y}),J;if(q.fields){let Q=q.fields;if(Array.isArray(Q))Q.forEach((j)=>{if(!j)return;let W=j.name||j.field||"",Y=B(W),Z=typeof j.value==="string"?j.value:Array.isArray(j.value)?j.value[0]:j.value!=null?String(j.value):"";if(W)J[W]=Z;if(Y&&Y!==W)J[Y]=Z});else if(typeof Q==="object")Object.entries(Q).forEach(([j,W])=>{let Y=B(j),Z=typeof W==="string"?W:Array.isArray(W)?W[0]:W!=null?String(W):"";if(J[j]=Z,Y&&Y!==j)J[Y]=Z});return J}return Object.entries(q).forEach(([Q,j])=>{let W=B(Q),Y=typeof j==="string"?j:Array.isArray(j)?j[0]:j!=null?String(j):"";if(J[Q]=Y,W&&W!==Q)J[W]=Y}),J}function L(q){let J=_(q,F),Q=J&&v(J);if(!Q)return $("Multi-practice question not answered yes, routing to success page",{field:F.find((j)=>q[j]),value:J,hasYes:Q}),"success";return $("Multi-practice question answered yes, routing to scheduler",{multiPracticeValue:J}),"general"}function g(q,J){let Q=U[q]||U.general,j=new URL(Q.url);return j.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([Z,X])=>{for(let z of X)if(J[z]){j.searchParams.set(Z,J[z]),$(`Mapping ${z} -> ${Z}: ${J[z]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach((Z)=>{if(J[Z])j.searchParams.set(Z,J[Z])}),$("Built scheduler URL:",j.toString()),j.toString()}function T(q,J){if(J==="success"){let Y=new URLSearchParams;if(q.email)Y.set("email",q.email);let Z=`${S.success}${Y.toString()?"?"+Y.toString():""}`;$("Redirecting to success page for soft rejection:",Z);try{window.location.replace(Z)}catch(X){$("replace() failed, using href for success redirect",X),window.location.href=Z}return}let Q={scheduler_type:J,formData:q,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(Q)),$("Stored router data in sessionStorage")}catch(Y){$("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${J}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(q))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(q)),$("Stored form data in localStorage for prefill")}catch(Y){$("Failed to store form data in localStorage:",Y)}let j=new URLSearchParams;if(q.email)j.set("email",q.email);let W=`${S.schedule}${j.toString()?"?"+j.toString():""}`;$("Redirecting to:",W);try{window.location.replace(W)}catch(Y){$("replace() failed, using href for scheduler redirect",Y),window.location.href=W}}function V(q,J={}){if($("Form submission detected:",q),M){$("Routing already performed; skipping");return}M=!0;let Q=P();if(Q){if(!q[G])q[G]=Q;try{sessionStorage.setItem(G,Q)}catch(W){$("Failed to persist partnerstack id in sessionStorage:",W)}try{localStorage.setItem(G,Q)}catch(W){$("Failed to persist partnerstack id in localStorage:",W)}}let j=L(q);if(T(q,j),typeof window.amplitude<"u")window.amplitude.track("scheduler_router_triggered",{scheduler_type:j,has_email:!!q.email,has_name:!!(q.firstname||q.first_name)});if(typeof window.posthog<"u")window.posthog.capture("scheduler_router_triggered",{scheduler_type:j,method:"redirect"})}function D(){window._capturedFormData=window._capturedFormData||{};let q={},J=new WeakSet;function Q(W,Y="change"){if(!W.name)return;let Z=W.name,X=B(Z),z=W.value,H=z;if(W.type==="radio"){let x=W.closest("label");if(x&&x.textContent){let w=x.textContent.replace(/\s+/g," ").trim();if(w)H=w}}if(q[Z]===H)return;if(q[Z]=H,Z==="hs_context"||Z.startsWith("hs_")||Z==="guid")return;if(window._capturedFormData[Z]=H,X&&X!==Z)window._capturedFormData[X]=H;if(W.type==="radio"){if(window._capturedFormData[`${Z}_raw`]=z,X&&X!==Z)window._capturedFormData[`${X}_raw`]=z;let x=document.querySelector(`input[type="hidden"][name="${Z}"]`);if(x&&x.value){if(window._capturedFormData[Z]=x.value,X&&X!==Z)window._capturedFormData[X]=x.value;H=x.value}}if(H){let x=W.type||W.tagName.toLowerCase();if(W.type==="tel"||Z.toLowerCase().includes("phone")){let w=H.replace(/[\s\-\(\)\.]/g,"");if(w)window._capturedFormData[Z+"_clean"]=w;$("Captured phone:",Z,"=",H)}else if(W.type==="radio")$("Captured radio selection:",Z,"=",H,"(raw:",z,")");else if(W.type==="hidden"){if(Z==="hs_context"||Z.startsWith("hs_")||Z==="guid")return;if(W.closest(".hsfc-DropdownField"))$("Captured dropdown:",Z,"=",H);else $("Captured field:",Z,"=",H)}else $("Captured",x+":",Z,"=",H)}}function j(){let W=P();if(W)y(W);let Y=new MutationObserver((X)=>{let z=[];if(X.forEach((H)=>{H.addedNodes.forEach((x)=>{if(x.nodeType===1)z.push(x)})}),z.length===0)return;z.forEach((H)=>{let x=H.querySelectorAll?H.querySelectorAll("input[name], select[name], textarea[name]"):[];if(H.tagName&&(H.tagName==="INPUT"||H.tagName==="SELECT"||H.tagName==="TEXTAREA")&&H.name)Z(H);x.forEach((w)=>Z(w))})});function Z(X){if(J.has(X))return;if(J.add(X),X.readOnly&&X.type!=="hidden")return;let z=X.name?B(X.name):"";if((X.name===G||z===G)&&!X.value){let H=P();if(H)X.value=H,Q(X,"partnerstack_prefill")}if(X.type==="hidden"&&X.name){let H=X.value,x=setInterval(()=>{if(X.value!==H)H=X.value,Q(X,"programmatic");if(!document.body.contains(X))clearInterval(x)},500);if(X.value)Q(X,"initial");else{let w=P();if(w&&(X.name===G||B(X.name)===G))X.value=w,Q(X,"partnerstack_prefill_hidden")}}else if(X.type==="radio")X.addEventListener("change",()=>Q(X));else if(X.type==="tel"||X.name&&X.name.toLowerCase().includes("phone"))X.addEventListener("blur",()=>Q(X)),X.addEventListener("change",()=>Q(X));else if(X.addEventListener("change",()=>Q(X)),X.addEventListener("blur",()=>Q(X)),X.value)Q(X,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach(Z),Y.observe(document.body,{childList:!0,subtree:!0}),$("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",j);else j()}function C(q){if(!q)return!1;let J=!!_(q,F);return Boolean(q.email||q.firstname||q.first_name||q.lastname||q.last_name||q.company||q.practice_name)||J}function f(){if(M){if(b)clearTimeout(b),b=null;return}if(!window._capturedFormData||Object.keys(window._capturedFormData).length===0){if(O)$("Multistep completion check: No form data captured yet");return}if(O)$("Multistep completion check: Checking for thank you message...",{hasFormData:!!window._capturedFormData,formDataKeys:Object.keys(window._capturedFormData).length});let q=[".submitted-message",".hs_submit_success",".hs-form-success","[data-submitted-message]",".submitted-message-content"];for(let J of q)try{let Q=document.querySelector(J);if(Q){let j=(Q.textContent||Q.innerText||"").toLowerCase();if(j.includes("thank")||j.includes("submitted")||j.includes("success")){if($("Multistep form completion detected via thank you message"),console.log("[HubSpot Router] Thank you message found",{selector:J,text:j.substring(0,100),hasRoutingData:C(window._capturedFormData)}),C(window._capturedFormData))$("Triggering redirect from multistep fallback"),console.log("[HubSpot Router] Executing redirect via fallback"),V(window._capturedFormData);else console.warn("[HubSpot Router] Thank you found but no routing data available");return}}}catch(Q){}}function s(q={}){$("Initializing postMessage listener"),window.addEventListener("message",function(J){if(!function(Z){try{let X=new URL(Z).hostname;return X.endsWith("hubspot.com")||X.endsWith("hsforms.com")||X.endsWith("hsforms.net")||X.endsWith("hsappstatic.net")||X.includes("hubspot")||X.includes("hsforms")}catch(X){return!1}}(J.origin))return;let j=J.data;if(typeof j==="string")try{j=JSON.parse(j)}catch(Z){}$("Received message from HubSpot:",j);let W=j&&(j.type||j.messageType),Y=j&&j.eventName;if(j&&W==="hsFormCallback"&&(Y==="onFormSubmitted"||Y==="onFormSubmit")){let Z=j&&j.data?E(j.data):{},z={...window._capturedFormData&&typeof window._capturedFormData==="object"?window._capturedFormData:{},...Z};if(!C(z)){if(Y==="onFormSubmit"){if($("onFormSubmit received without routing fields; waiting for onFormSubmitted event"),!b)console.log("[HubSpot Router] Setting up multistep fallback timer"),b=setTimeout(()=>{console.log("[HubSpot Router] Starting multistep completion checks");let H=0,x=10,w=setInterval(()=>{if(H++,O||H===1||H===x)console.log(`[HubSpot Router] Multistep check ${H}/${x}`);if(f(),M||H>=x){if(clearInterval(w),b=null,H>=x)console.warn("[HubSpot Router] Multistep fallback checks completed without redirect")}},500)},1000)}else $("Submission payload lacks routing data; skipping redirect");return}if(b)clearTimeout(b),b=null;try{window._capturedFormData={...z}}catch(H){$("Failed to persist merged submission data globally:",H)}V(z,q)}else if(j&&j.formGuid&&j.accepted===!0){if($("Developer embed submission detected"),$("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){if(b)clearTimeout(b),b=null;try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),$("Stored captured form data in localStorage for prefill")}catch(Z){$("Failed to store captured form data in localStorage:",Z)}V(window._capturedFormData,q)}}else if(j&&W==="hsFormCallback"&&O)$("Ignoring hsFormCallback event:",Y)}),$("PostMessage listener initialized")}function N(q={}){let Q={...{redirect:!0,debug:O},...q};if(Q.debug)window.HubSpotRouterDebug={config:U,determineSchedulerType:L,buildSchedulerUrl:g,handleFormSubmission:V},$("Debug mode enabled. Access via window.HubSpotRouterDebug");D(),s(Q),$("HubSpot Form Router initialized with config:",Q)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>N());else N();window.HubSpotRouter={...window.HubSpotRouter,init:N,handleFormSubmission:V,determineSchedulerType:L,buildSchedulerUrl:g,config:U,DEBUG:O},$("HubSpot Form Router loaded"),console.log("[HubSpot Router] Script loaded",{debug:O,hasRouter:!!window.HubSpotRouter,url:window.location.href})})();
