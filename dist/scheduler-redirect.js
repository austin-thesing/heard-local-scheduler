(function(){let P={sole_prop:{url:"https://meetings.hubspot.com/bz/consultation",name:"Sole Proprietor Consultation",description:"For single-owner practices"},s_corp:{url:"https://meetings.hubspot.com/bz/consultations",name:"S-Corp Consultation",description:"For multi-owner practices"}},A=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function Z(...W){if(A)console.log("[HubSpot Router]",...W)}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=A;let R=!1;function B(W){try{if(!W)return"";let X=String(W);return X.indexOf("/")!==-1?X.split("/").pop():X}catch(X){return W}}function C(W){let X={};if(!W)return X;if(Array.isArray(W))return W.forEach((J)=>{if(!J)return;let q=J.name||J.field||"",Q=B(q),$=typeof J.value==="string"?J.value:Array.isArray(J.value)?J.value[0]:J.value!=null?String(J.value):"";if(q)X[q]=$;if(Q&&Q!==q)X[Q]=$}),X;if(W.fields){let J=W.fields;if(Array.isArray(J))J.forEach((q)=>{if(!q)return;let Q=q.name||q.field||"",$=B(Q),j=typeof q.value==="string"?q.value:Array.isArray(q.value)?q.value[0]:q.value!=null?String(q.value):"";if(Q)X[Q]=j;if($&&$!==Q)X[$]=j});else if(typeof J==="object")Object.entries(J).forEach(([q,Q])=>{let $=B(q),j=typeof Q==="string"?Q:Array.isArray(Q)?Q[0]:Q!=null?String(Q):"";if(X[q]=j,$&&$!==q)X[$]=j});return X}return Object.entries(W).forEach(([J,q])=>{let Q=B(J),$=typeof q==="string"?q:Array.isArray(q)?q[0]:q!=null?String(q):"";if(X[J]=$,Q&&Q!==J)X[Q]=$}),X}function z(W){Z("Determining scheduler type from form data:",W);let X=["is_your_practice_a_c_corp_or_our_does_it_have_multiple_owners_","does_your_practice_have_multiple_owners","multiple_owners","practice_multiple_owners","has_multiple_owners"],J=null;for(let Q of X)if(W[Q]){J=W[Q],Z(`Found multiple owners field: ${Q} = ${J}`);break}if(!J)return Z("No multiple owners field found, using default"),"default";let q=J.toString().toLowerCase().trim();if(q==="no"||q==="false")return Z("Single owner detected -> sole_prop"),"sole_prop";else if(q==="yes"||q==="true")return Z("Multiple owners detected -> s_corp"),"s_corp";return Z("Unclear response, using default"),"default"}function _(W,X){let J=P[W]||P.default,q=new URL(J.url);return q.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([j,Y])=>{for(let x of Y)if(X[x]){q.searchParams.set(j,X[x]),Z(`Mapping ${x} -> ${j}: ${X[x]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach((j)=>{if(X[j])q.searchParams.set(j,X[j])}),Z("Built scheduler URL:",q.toString()),q.toString()}function G(W,X){let J={scheduler_type:X,formData:W,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(J)),Z("Stored router data in sessionStorage")}catch($){Z("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${X}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(W))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(W)),Z("Stored form data in localStorage for prefill")}catch($){Z("Failed to store form data in localStorage:",$)}let q=new URLSearchParams;if(W.email)q.set("email",W.email);let Q=`/hs-scheduler/ty-general${q.toString()?"?"+q.toString():""}`;Z("Redirecting to:",Q),window.location.href=Q}function L(W,X={}){if(Z("Form submission detected:",W),R){Z("Routing already performed; skipping");return}R=!0;let J=z(W);if(G(W,J),typeof window.amplitude!=="undefined")window.amplitude.track("scheduler_router_triggered",{scheduler_type:J,has_email:!!W.email,has_name:!!(W.firstname||W.first_name)});if(typeof window.posthog!=="undefined")window.posthog.capture("scheduler_router_triggered",{scheduler_type:J,method:"redirect"})}function b(){window._capturedFormData=window._capturedFormData||{};let W={},X=new WeakSet;function J(Q,$="change"){if(!Q.name)return;let{value:j,name:Y}=Q;if(W[Y]===j)return;if(W[Y]=j,Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if(window._capturedFormData[Y]=j,j){let x=Q.type||Q.tagName.toLowerCase();if(Q.type==="tel"||Y.toLowerCase().includes("phone")){let M=j.replace(/[\s\-\(\)\.]/g,"");if(M)window._capturedFormData[Y+"_clean"]=M;Z("Captured phone:",Y,"=",j)}else if(Q.type==="radio")Z("Captured radio selection:",Y,"=",j);else if(Q.type==="hidden"){if(Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if(Q.closest(".hsfc-DropdownField"))Z("Captured dropdown:",Y,"=",j);else Z("Captured field:",Y,"=",j)}else Z("Captured",x+":",Y,"=",j)}}function q(){let Q=new MutationObserver((j)=>{let Y=[];if(j.forEach((x)=>{x.addedNodes.forEach((M)=>{if(M.nodeType===1)Y.push(M)})}),Y.length===0)return;Y.forEach((x)=>{let M=x.querySelectorAll?x.querySelectorAll("input[name], select[name], textarea[name]"):[];if(x.tagName&&(x.tagName==="INPUT"||x.tagName==="SELECT"||x.tagName==="TEXTAREA")&&x.name)$(x);M.forEach((O)=>$(O))})});function $(j){if(X.has(j))return;if(X.add(j),j.readOnly&&j.type!=="hidden")return;if(j.type==="hidden"&&j.name){let Y=j.value,x=setInterval(()=>{if(j.value!==Y)Y=j.value,J(j,"programmatic");if(!document.body.contains(j))clearInterval(x)},500);if(j.value)J(j,"initial")}else if(j.type==="radio")j.addEventListener("change",()=>J(j));else if(j.type==="tel"||j.name&&j.name.toLowerCase().includes("phone"))j.addEventListener("blur",()=>J(j)),j.addEventListener("change",()=>J(j));else if(j.addEventListener("change",()=>J(j)),j.addEventListener("blur",()=>J(j)),j.value)J(j,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach($),Q.observe(document.body,{childList:!0,subtree:!0}),Z("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",q);else q()}function I(W={}){Z("Initializing postMessage listener"),window.addEventListener("message",function(X){if(!function(j){try{let Y=new URL(j).hostname;return Y.endsWith("hubspot.com")||Y.endsWith("hsforms.com")||Y.endsWith("hsforms.net")||Y.endsWith("hsappstatic.net")||Y.includes("hubspot")||Y.includes("hsforms")}catch(Y){return!1}}(X.origin))return;let q=X.data;if(typeof q==="string")try{q=JSON.parse(q)}catch(j){}Z("Received message from HubSpot:",q);let Q=q&&(q.type||q.messageType),$=q&&q.eventName;if(q&&Q==="hsFormCallback"&&($==="onFormSubmitted"||$==="onFormSubmit")){let j=q.data;if(j){let Y=C(j);L(Y,W)}}else if(q&&q.formGuid&&q.accepted===!0){if(Z("Developer embed submission detected"),Z("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),Z("Stored captured form data in localStorage for prefill")}catch(j){Z("Failed to store captured form data in localStorage:",j)}L(window._capturedFormData,W)}}else if(q&&Q==="hsFormCallback"&&A)Z("Ignoring hsFormCallback event:",$)}),Z("PostMessage listener initialized")}function H(W={}){let J={...{redirect:!0,debug:A},...W};if(J.debug)window.HubSpotRouterDebug={config:P,determineSchedulerType:z,buildSchedulerUrl:_,handleFormSubmission:L},Z("Debug mode enabled. Access via window.HubSpotRouterDebug");b(),I(J),Z("HubSpot Form Router initialized with config:",J)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>H());else H();window.HubSpotRouter={...window.HubSpotRouter,init:H,handleFormSubmission:L,determineSchedulerType:z,buildSchedulerUrl:_,config:P,DEBUG:A},Z("HubSpot Form Router loaded")})();
